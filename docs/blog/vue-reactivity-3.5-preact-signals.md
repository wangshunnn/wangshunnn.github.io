---
title: Vue Signals è¿›åŒ–è®ºï¼ˆv3.5ï¼‰ï¼šPreact é‡æ„å¯ç¤ºå½•
date: 2025-3-7
lang: zh
duration: 13 min
description: Vue 3.5 å“åº”å¼é‡æ„çš„èƒŒåæ˜¯ Preact Signals å¸¦æ¥çš„åŸºå› çªå˜
tag: Vue, Signals
place: åŒ—äº¬
---

# Vue Signals è¿›åŒ–è®ºï¼ˆv3.5ï¼‰ï¼šPreact é‡æ„å¯ç¤ºå½•

<br/>

> **âœ¨ AI æ‘˜è¦**
> 
> Vue 3.5 çš„å“åº”å¼ç³»ç»Ÿé€šè¿‡å€Ÿé‰´ Preact Signals çš„åŒå‘é“¾è¡¨ç»“æ„ä¸ç‰ˆæœ¬è®¡æ•°æœºåˆ¶å®ç°çªç ´æ€§é‡æ„ã€‚æ–°æ¶æ„ä»¥ Link èŠ‚ç‚¹ä¸ºæ¡¥æ¢ï¼Œè§£è€¦è®¢é˜…è€…ï¼ˆSubï¼‰ä¸ä¾èµ–é¡¹ï¼ˆDepï¼‰ï¼Œé€šè¿‡åŒå‘é“¾è¡¨å®ç°é«˜æ•ˆä¾èµ–æ”¶é›†ä¸è§¦å‘ï¼Œå†…å­˜å ç”¨å‡å°‘ 56%ã€‚ç‰ˆæœ¬è®¡æ•°æœºåˆ¶ä¼˜åŒ–è®¡ç®—å±æ€§ï¼ˆcomputedï¼‰çš„æƒ°æ€§è®¡ç®—ä¸ç¼“å­˜ç­–ç•¥ï¼Œä»…åœ¨ä¾èµ–å˜æ›´æ—¶é‡æ–°è®¡ç®—ã€‚æ­¤æ¬¡é‡æ„è¿˜å¼•å…¥æƒ°æ€§è®¢é˜…ç‰¹æ€§ï¼Œè®¡ç®—å±æ€§ä»…åœ¨é¦–æ¬¡è¢«å¼•ç”¨æ—¶å»ºç«‹ä¾èµ–å…³ç³»ï¼Œå‡å°‘å†—ä½™æ€§èƒ½æ¶ˆè€—ã€‚Vue 3.5 çš„é©æ–°ä¸ä»…å»¶ç»­äº† Preact çš„â€œä¿¡å·å“²å­¦â€ï¼Œæ›´ä¸ºæœªæ¥ Alien Signals çš„æ·±åº¦ä¼˜åŒ–å¥ å®šåŸºç¡€ã€‚

## åºè¨€

Signals ä¸»é¢˜æµ©ç€šï¼Œéé„™äººå¯ä¹¦ã€‚æˆ‘å°†ä»¥ Vue çš„å“åº”å¼æ¼”è¿›ä¸ºè½´å¿ƒï¼Œæ¢ç´¢å‰ç«¯ Signals å‘å±•æ½®æµã€‚æ—¨åœ¨å­¦ä¹ æ¢ç´¢ Signals æŠ€æœ¯å’Œ Vue å“åº”å¼åŸç†ã€‚

## Signals æ¦‚å¿µ

Signalsï¼ˆä¿¡å·ï¼‰å¯è°“æ˜¯å½“ä¸‹å‰ç«¯æ¡†æ¶å’Œå“åº”å¼ç¼–ç¨‹ç•Œçš„â€œæ½®æµâ€ï¼Œä¸»è¦åº”ç”¨å’Œæµè¡Œäºå“åº”å¼çŠ¶æ€ç®¡ç†æ¡†æ¶ä¸­ï¼Œæ¯”å¦‚ä»£è¡¨æ€§çš„ [Preact](https://preactjs.com/),Â [Qwik](https://qwik.dev/),Â [Solid](https://www.solidjs.com/)ï¼Œç”šè‡³è€ç‰Œçš„ [Angular](https://angular.dev/guide/signals) ä¹Ÿåœ¨æ–°ç‰ˆæœ¬æ”¯æŒäº† Signalsã€‚å¦å¤–åƒÂ [Vue](https://vuejs.org/)ã€[MobX](https://mobx.js.org/) è™½ç„¶æ²¡æœ‰ç›´æ¥å‘½å Signalsï¼Œä½†å…¶å†…éƒ¨çš„å“åº”å¼è®¾è®¡å“²å­¦ä¹Ÿæ˜¯å’Œ Signals æ¦‚å¿µä¸€è„‰ç›¸æ‰¿ã€‚

è€ƒè™‘åˆ°ä¸åŒæ¡†æ¶ä¸­å…³äºä¿¡å·å®ç°å„æœ‰ä¸åŒï¼ŒTC39 æå‡ºäº†å…³äºæ¡†æ¶æ— å…³çš„ Signals æ ‡å‡†åŒ–å®ç°çš„ææ¡ˆï¼Œç›®å‰å·²ç»è¿›å…¥ Stage1 é˜¶æ®µï¼Œæˆ–è®¸åœ¨æœªæ¥æˆ‘ä»¬èƒ½åœ¨ä¸åŒå‰ç«¯æ¡†æ¶ä¸­çœ‹è§åŸºäºç»Ÿä¸€ Signals æ ‡å‡†çš„å“åº”å¼å®ç°ã€‚æ›´å¤šææ¡ˆç»†èŠ‚ä»¥åŠå†å²èƒŒæ™¯è¯·ç§»æ­¥ [tc39/proposal-signals](https://github.com/tc39/proposal-signals)ã€‚

å…³äº Signalsï¼ˆä¿¡å·ï¼‰è¿™ä¸€æŠ½è±¡æ¦‚å¿µçš„è§£é‡Šï¼Œä¸ªäººè®¤ä¸º Preact å®˜æ–¹æ–‡æ¡£ä¸­çš„å®šä¹‰ç‰¹åˆ«åˆé€‚ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼šâ€œ[*Signals are reactive primitives for managing application state.*](https://preactjs.com/guide/v10/signals)â€ã€‚å®˜ç½‘ç¿»è¯‘æ˜¯ï¼Œä¿¡å·æ˜¯ç”¨äºç®¡ç†åº”ç”¨ç¨‹åºçŠ¶æ€çš„å“åº”åŸå§‹æ¦‚å¿µã€‚ä¸ªäººæ›´å€¾å‘å°† â€œprimitivesâ€ ä¸€è¯ç¿»è¯‘ä¸ºâ€åŸè¯­â€œï¼Œå³å“åº”å¼ä¸­çš„åŸºç¡€ç»„ä»¶ã€æœ€å°å•å…ƒã€‚

![Preact å®˜æ–¹æ–‡æ¡£ Signals ä»‹ç»](/vue-reactivity-3.5-preact-signals/preact-signals-introduce.png)

Preact å®˜æ–¹æ–‡æ¡£ Signals ä»‹ç»

## æ¡†æ¶å¯¹æ¯” Benchmark

ä¸‹å›¾æ˜¯å½“å‰å„ä¸ªä¿¡å·æ¡†æ¶çš„ [æ€§èƒ½å¯¹æ¯”ç¤ºæ„å›¾](https://github.com/transitive-bullshit/js-reactivity-benchmark)ï¼Œä¸çœ‹å›¾éƒ½ä¸çŸ¥é“åŸæ¥è¿™ä¹ˆå¤š Signals æ¡†æ¶ï¼Œå¯è°“ç™¾å®¶äº‰é¸£ã€‚

![å‰ç«¯ Signals æ¡†æ¶æ€§èƒ½å¯¹æ¯”](/vue-reactivity-3.5-preact-signals/benchmark.png)

å‰ç«¯ Signals æ¡†æ¶æ€§èƒ½å¯¹æ¯”

## 1. Preact Signals

æœ¬æ–‡åŠ¨æœºå…¶å®å°±æ˜¯ç¼˜äº [Preact signals](https://github.com/preactjs/signals)ï¼Œç†ç”±å¦‚ä¸‹ï¼š

- æ€§èƒ½ä¼˜å¼‚ï¼Œæ–‡æ¡£è¯¦å®ã€‚
- Preact å°è£…äº†æ¡†æ¶æ— å…³çš„ signals åŸºç¡€åº“ [@preact/signals-core](https://github.com/preactjs/signals/blob/main/packages/core/src/index.ts)ï¼Œæºä»£ç ç®€æ´ä¼˜é›…é«˜èšåˆï¼Œå’Œ Vue æºç çš„å¤æ‚è„‰ç»œç›¸æ¯”ï¼Œå¯¹è¯»è€…ä¹Ÿæ›´åŠ å‹å¥½ã€‚
- å®ƒçš„â€œç‰ˆæœ¬è®¡æ•°â€å’Œâ€œåŒå‘é“¾è¡¨ç»“æ„â€çš„è®¾è®¡ç›´æ¥å¯å‘äº† [Vue3.5 å“åº”å¼é‡æ„](https://github.com/vuejs/core/pull/10397)ï¼Œçœ‹å®Œå®ƒå†å»çœ‹ Vue3.5 è‡ªç„¶ä¸€ç‚¹å°±é€šã€‚

å¦å¤–ï¼Œå¦‚æœä½ å»çœ‹ Preact [å®˜æ–¹åšå®¢](https://preactjs.com/blog/signal-boosting)ï¼Œä¼šå‘ç°æœ‰ä¸¤ä¸ªé«˜é¢‘è¯æ±‡ dependency  å’Œ dependent ï¼ŒäºŒè€…çœ‹ç€ç›¸ä¼¼å…¶å®ç›¸åï¼š

- `Dependent` ï¼šæŒ‡çš„æ˜¯ä¾èµ–æŸä¸ªï¼ˆäº›ï¼‰ä¿¡å·çš„ `computed/effect` ï¼Œç›¸å½“äº Vue é‡Œæ‰€è¯´çš„ `Subs`ï¼ˆè®¢é˜…è€…ï¼‰ã€‚
- `Dependency` ï¼šæŒ‡çš„æ˜¯è¢«å½“å‰ `computed/effect` ä¾èµ–çš„å„ä¸ª `signal`ï¼Œç›¸å½“äº Vue é‡Œæ‰€è¯´çš„ `Deps`ï¼ˆä¾èµ–é¡¹ï¼‰ã€‚

### API ç”¨æ³•

Preact ä¿¡å· API ç”¨æ³•å¦‚ä¸‹ï¼š

```ts twoslash
import { signal, computed, effect } from "@preact/signals-core";

const count = signal(1);
const double = computed(() => count.value * 2);
const quadruple = computed(() => double.value * 2);

// Console: quadruple = 4
effect(() => {
  console.log("quadruple =", quadruple.value);
});

// Console: quadruple = 80
count.value = 20;
```

è¿™é‡Œ `signal` ç”¨æ³•å’Œ Vue é‡Œçš„ [`ref`](https://vuejs.org/api/reactivity-core.html#ref) ç‰¹åˆ«ç›¸ä¼¼ï¼Œå…¶å®ä¸¥æ ¼æ¥è¯´å’Œ [`shallowRef`](https://vuejs.org/api/reactivity-advanced.html#shallowref) æ›´ä¸ºè´´è¿‘ï¼Œå› ä¸ºåŒæ ·éƒ½æ˜¯åªæœ‰å¯¹Â `.value`Â çš„è®¿é—®æ˜¯å“åº”å¼çš„ï¼Œå¦‚æœ value æ˜¯ä¸ªå¯¹è±¡å¹¶ä¸ä¼šæ·±å±‚é€’å½’åœ°è½¬ä¸ºå“åº”å¼å¯¹è±¡ã€‚

```ts
import { shallowRef } from 'vue'

const signal = (initialValue) => shallowRef(initialValue)
```

å…¶ä»–æ¡†æ¶ä¿¡å· API å’Œ Vue çš„å·®å¼‚å’Œå…³è”å¯ä»¥å‚è€ƒ [Vue å®˜æ–¹æ–‡æ¡£](https://cn.vuejs.org/guide/extras/reactivity-in-depth.html#connection-to-signals)ã€‚æ— è®ºæ˜¯ä¸åŒæ¡†æ¶çš„ `signal` è¿˜æ˜¯ Vue çš„ `ref`ï¼ŒAPI é£æ ¼å…¶å®æ˜¯ä¸»è§‚çš„ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯ç›¸åŒçš„å“åº”å¼åŸºç¡€ã€‚

### è®¾è®¡åŸåˆ™

Preact Signals éµå¾ªä»¥ä¸‹è®¾è®¡åŸåˆ™ï¼š

1. **ä¾èµ–è·Ÿè¸ªï¼ˆ`Automatic Dependency Tracking`ï¼‰**ï¼šè‡ªåŠ¨è·Ÿè¸ªä½¿ç”¨çš„ä¿¡å·ï¼ˆæ™®é€šæˆ– `computed` ä¿¡å·ï¼‰ï¼Œå³ä½¿ä¾èµ–å…³ç³»å¯èƒ½ä¼šåŠ¨æ€æ›´æ”¹ã€‚ä¸åƒ React hooks é‚£æ ·æ‰‹åŠ¨æŒ‡å®šä¾èµ–æ•°ç»„ã€‚
2. **ç¼“å­˜ï¼ˆ`Memoization/Caching`ï¼‰**ï¼š`computed` ä¿¡å·åªä¼šåœ¨å®ƒçš„ä¾èµ–é¡¹å¯èƒ½å·²ç»æ”¹å˜æ—¶æ‰é‡æ–°è®¡ç®—ã€‚
3. **æƒ°æ€§/å»¶è¿Ÿæ‰§è¡Œï¼ˆ`Laziness`ï¼‰ï¼š**`computed` ä¿¡å·åªä¼šæŒ‰éœ€è®¡ç®—ã€‚å¦‚æœæ²¡æœ‰ä½¿ç”¨è¿™ä¸ª `computed` ä¿¡å·ï¼Œé‚£ä¹ˆæ°¸è¿œä¸ä¼šæ‰§è¡Œï¼Œé¿å…æ€§èƒ½æµªè´¹ã€‚
4. **ä¸»åŠ¨æ€§/ç«‹å³æ‰§è¡Œï¼ˆ`Eagerness`ï¼‰**ï¼šå½“ `effect` çš„ä¾èµ–é“¾ä¸­çš„æŸäº›å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒåº”è¯¥å°½å¿«è¿è¡Œã€‚

è¿™å‡ æ¡è®¾è®¡åŸåˆ™å‡ ä¹é€‚ç”¨äºæ‰€æœ‰ä¿¡å·æ¡†æ¶ï¼ŒçŠ¹å¦‚é˜¿è¥¿è«å¤«çš„ [æœºå™¨äººä¸‰å®šå¾‹](https://en.wikipedia.org/wiki/Three_Laws_of_Robotics)ï¼Œæ˜¯æ„å»ºå“åº”å¼ç³»ç»Ÿçš„â€œé“â€ã€‚

### åŒå‘é“¾è¡¨ï¼ˆdoubly-linked listï¼‰

åœ¨ Vue3.5 ä¹‹å‰ï¼Œ`Sub`ï¼ˆè®¢é˜…è€…ï¼‰ å’Œ `Dep`ï¼ˆä¾èµ–é¡¹ï¼‰ å…³ç³»æ˜¯å¤šå¯¹å¤šçš„ç½‘çŠ¶å…³ç³»ï¼Œå¹¶ä¸”ä¸¤è€…æ˜¯ç›´æ¥å…³è”çš„ã€‚è€Œåœ¨ Preact Signals æºç ä¸­ä½¿ç”¨äº†åŒå‘é“¾è¡¨ç»“æ„æ¥å¤„ç† `signal`ï¼ˆä¾èµ–é¡¹ï¼‰å’Œ `computed/effect`ï¼ˆè®¢é˜…è€…ï¼‰ä¹‹é—´çš„è”ç³»ã€‚ä¾èµ–å’Œè®¢é˜…è€…ä¹‹é—´ä¸å†ç›´æ¥å…³è”ï¼Œè€Œæ˜¯é€šè¿‡ä¸­é—´èŠ‚ç‚¹æ¥å…³è”ï¼Œç›¸å½“äºé’ˆå¯¹â€œå‘å¸ƒ-è®¢é˜…â€æ¨¡å¼çš„ä¸€ç§â€œä¸­ä»‹åŒ–â€å˜ä½“å‡çº§ã€‚

å•ä»æºç æ¥ç†è§£è¿™ä¸ªåŒå‘é“¾è¡¨å…¶å®æ¯”è¾ƒæŠ½è±¡ï¼Œå—ä¸€ç¯‡ [Vue3.5 å…¬ä¼—å·æ–‡ç« ](https://mp.weixin.qq.com/s/_KQyb9cQv-r-tR2gTT0ZCQ) ä¸­â€œåæ ‡ç³»â€å¯å‘ï¼Œæˆ‘ç»˜åˆ¶äº†å¦‚ä¸‹çš„ Preact Signals åŒå‘é“¾è¡¨çš„åŸç†å›¾ã€‚

- æ¨ªå‘æ¥çœ‹ï¼Œå³ä» `computed/effect` ï¼ˆè®¢é˜…è€…ï¼‰çº¬åº¦ï¼Œå®ƒæŒ‡å‘çš„åŒå‘é“¾è¡¨ç»´æŠ¤ç€å®ƒçš„**ä¾èµ–é¡¹é“¾è¡¨**ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„ `_source` å±æ€§éƒ½æŒ‡å‘å®ƒä¾èµ–çš„ä¸€ä¸ª `signal`ï¼ˆä¾èµ–é¡¹ï¼‰ï¼Œé‡åˆ°æ–°çš„ä¾èµ–é¡¹å°±ä¼šåœ¨é“¾è¡¨é˜Ÿå°¾æ–°å¢ä¸€ä¸ª `node` èŠ‚ç‚¹ï¼Œç„¶åä¿®æ”¹ `computed/effect` çš„ `_sources` å±æ€§æŒ‡å‘é˜Ÿå°¾ã€‚
- çºµå‘æ¥çœ‹ï¼Œå³ä» `signal` ï¼ˆä¾èµ–é¡¹ï¼‰çº¬åº¦ï¼Œå®ƒæŒ‡å‘çš„åŒå‘é“¾è¡¨ç»´æŠ¤ç€ä¾èµ–å®ƒçš„**è®¢é˜…è€…é“¾è¡¨**ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„ `_target` å±æ€§éƒ½æŒ‡å‘ä¸€ä¸ªä¾èµ–å®ƒçš„ `computed/effect` ï¼ˆè®¢é˜…è€…ï¼‰ï¼Œé‡åˆ°æ–°çš„è®¢é˜…è€…å°±ä¼šåœ¨é“¾è¡¨é˜Ÿå°¾æ–°å¢ä¸€ä¸ª `node` èŠ‚ç‚¹ï¼Œç„¶åä¿®æ”¹ `signal` çš„ `_target` å±æ€§æŒ‡å‘é˜Ÿå°¾ã€‚
- ä¸€ä¸ªè®¢é˜…è€…å’Œä¸€ä¸ªä¾èµ–é¡¹ä¹‹é—´å­˜åœ¨å”¯ä¸€ä¸”å›ºå®šçš„ä¸€ä¸ªèŠ‚ç‚¹æ¥ç»´ç³»ï¼Œå½“ä¸€ä¸ªè®¢é˜…è€…é‡åˆ°ä¸€ä¸ªæ–°çš„ä¾èµ–é¡¹ï¼Œæ¯”å¦‚ä¸‹å›¾ä¸­çš„ `computed2` è¯»å–åˆ°æ–°çš„ä¾èµ– `signal2`ï¼š
    - å…ˆè¿›è¡Œä¾èµ–æ”¶é›†ï¼Œæ­¤é˜¶æ®µä¼šåœ¨æ¨ªå‘çš„ä¾èµ–é¡¹é“¾è¡¨é˜Ÿå°¾æ–°å¢ä¸€ä¸ªèŠ‚ç‚¹ `node4`ï¼Œç„¶åä¿®æ”¹è®¢é˜…è€… `computed2` çš„ `_sources` å±æ€§æŒ‡å‘æ–°çš„é˜Ÿå°¾ `node4`ã€‚
    - éšåï¼Œ`node4._source` æŒ‡å‘çš„ `signal2` å¼€å§‹æ›´æ–°è®¢é˜…é“¾è¡¨ï¼Œå°† `node4` æ·»åŠ åˆ°çºµå‘é“¾è¡¨çš„é˜Ÿé¦–ï¼Œä¿®æ”¹ `signal2` çš„ `_targets` å±æ€§æŒ‡å‘æ–°çš„é˜Ÿé¦– `node4` ã€‚

![Preact Signals åŒå‘é“¾è¡¨ç»“æ„ç¤ºæ„å›¾](/vue-reactivity-3.5-preact-signals/preact-signals-doubly-linked-list.png)

Preact Signals åŒå‘é“¾è¡¨ç»“æ„ç¤ºæ„å›¾

ä¸‹é¢æ˜¯è¯»å–ä¿¡å·æ—¶è¿›è¡Œä¾èµ–æ”¶é›†çš„æºç ï¼Œæˆ‘ä»¬å¯ä»¥é…åˆä¸Šå›¾ç†è§£ï¼Œçª¥ä¸€æ–‘è€ŒçŸ¥å…¨è±¹ã€‚

```ts
function addDependency(signal: Signal): Node | undefined {
	if (evalContext === undefined) {
		return undefined;
	}

	let node = signal._node;
	if (node === undefined || node._target !== evalContext) {
		// æ–°å¢ä¾èµ–é¡¹ï¼Œåˆ›å»ºæ–°çš„ node èŠ‚ç‚¹
		node = {
			_version: 0,
			_source: signal,
			_prevSource: evalContext._sources,
			_nextSource: undefined,
			_target: evalContext,
			_prevTarget: undefined,
			_nextTarget: undefined,
			_rollbackNode: node,
		};

		if (evalContext._sources !== undefined) {
			evalContext._sources._nextSource = node;
		}
		evalContext._sources = node;
		signal._node = node;

		if (evalContext._flags & TRACKING) {
			// æ›´æ–°ä¾èµ–è¯¥ signal çš„è®¢é˜…è€…é“¾è¡¨
			signal._subscribe(node);
		}
		return node;
	} else if (node._version === -1) {
		// åŒä¸€ä¸ªè®¢é˜…è€…é‡å¤æ”¶é›†åŒä¸€ä¸ªä¾èµ–æ—¶ï¼Œæ— éœ€é‡æ–°åˆ›å»ºæ–°çš„ node èŠ‚ç‚¹ï¼Œåªéœ€ä¿®æ”¹é“¾è¡¨å†…éƒ¨èŠ‚ç‚¹é¡ºåº
		// ..
	}
	return undefined;
}
```

åŒå‘é“¾è¡¨å¸¦æ¥çš„ä¼˜ç‚¹å¦‚ä¸‹ï¼š

1. **æ—¶é—´å¤æ‚åº¦æ›´ä½ï¼ˆæ•°æ®ç»“æ„ä¼˜åŒ–ï¼‰**
    - ä»»æ„ä½ç½®æ’å…¥/ç§»é™¤èŠ‚ç‚¹æ—¶åªéœ€ `O(1)`ï¼Œå¯¹æ¯”ä¼ ç»Ÿæ•°ç»„ä¾èµ–ç®¡ç†ï¼ˆ`push/splice` éœ€è¦ `O(n)` æ“ä½œï¼‰ï¼Œåœ¨é¢‘ç¹çš„ä¾èµ–å˜æ›´åœºæ™¯ä¸­æ€§èƒ½æ›´ä¼˜ã€‚
2. **å†…å­˜æ•ˆç‡æ›´é«˜ï¼ˆèŠ‚ç‚¹å¼•ç”¨æŒä¹…åŒ–ï¼‰**
    - æ¯ä¸€å¯¹è®¢é˜…è€…/ä¾èµ–é¡¹ä¹‹é—´ä¼šå»ºç«‹ä¸€ä¸ªå›ºå®šçš„Â `Node`Â èŠ‚ç‚¹ï¼Œä¾èµ–å…³ç³»ç¨³å®šåˆ™èŠ‚ç‚¹ç¨³å®šï¼Œé«˜é¢‘æ›´æ–°ä¹Ÿä¸ä¼šé”€æ¯é‡å»ºè€Œæ˜¯ä¸€ç›´å¤ç”¨ã€‚ä¼ ç»Ÿçš„å‘å¸ƒ-è®¢é˜…æ¨¡å¼å¯èƒ½ä¼šé¢‘ç¹åˆ›å»º/é”€æ¯Â `Watcher`Â å¯¹è±¡ï¼Œå¯¼è‡´ GC å‹åŠ›å¢å¤§ã€‚
3. **ç²¾å‡†ä¾èµ–è¿½è¸ª**
    - æ¯ä¸ª `Signal` ä¿¡å·ç»´æŠ¤è‡ªå·±çš„è®¢é˜…è€…é“¾è¡¨ï¼Œæ›´æ–°æ—¶ç›´æ¥éå†é“¾è¡¨é€šçŸ¥è®¢é˜…è€…ï¼Œé¿å…äº†ä¼ ç»Ÿå“åº”å¼ç³»ç»Ÿä¸­"ä¾èµ–æ”¶é›†-è§¦å‘æ›´æ–°"çš„å®Œæ•´æ ‘éå†è¿‡ç¨‹ã€‚

### ç‰ˆæœ¬è®¡æ•°

è¿™é‡Œçš„â€œç‰ˆæœ¬â€æŒ‡çš„æ˜¯æºç å®ç°ä¸­å¼•å…¥äº†ä¸€äº›ç§°ä¹‹ä¸º `version`ï¼ˆç‰ˆæœ¬ï¼‰çš„æ•°å­—ç±»å‹å˜é‡ï¼š

- `globalVersion`ï¼šå…¨å±€ç»´æŠ¤çš„ä¸€ä¸ªç‰ˆæœ¬å·
- `Signal._globalVersion`ï¼šæ¯ä¸ªä¿¡å·å®ä¾‹å†…éƒ¨ç»´æŠ¤çš„ä¸€ä¸ªå…¨å±€ç‰ˆæœ¬å·ï¼Œä¸»è¦ç”¨äºå’Œå…¨å±€ç‰ˆæœ¬å·è¿›è¡ŒåŒæ­¥/å¯¹æ¯”
- `Signal._version`ï¼šæ¯ä¸ªä¿¡å·å®ä¾‹å†…éƒ¨ç»´æŠ¤çš„ä¸€ä¸ªå†…éƒ¨ç‰ˆæœ¬å·ï¼Œä¸»è¦ç”¨äºå’Œè‡ªèº«å†å²ç‰ˆæœ¬å¯¹æ¯”
- `Node._version`ï¼šæ¯ä¸ªä¸­é—´èŠ‚ç‚¹å®ä¾‹å†…éƒ¨ç»´æŠ¤çš„ä¸€ä¸ªå†…éƒ¨ç‰ˆæœ¬å·ï¼Œä¸»è¦ç”¨äºå’Œè‡ªèº«å†å²ç‰ˆæœ¬å¯¹æ¯”

â€œç‰ˆæœ¬è®¡æ•°â€è®¾è®¡çš„æœ€å¤§è·ç›Šè€…å½“å± `computed`ï¼Œå€Ÿæ­¤å®ç°é«˜æ•ˆçš„æƒ°æ€§ç¼“å­˜ï¼ˆLazy & Cachedï¼‰ç‰¹æ€§ï¼Œå¤§å¤§æå‡æ€§èƒ½ã€‚

### Computed ç¼“å­˜ä¹‹é“

æœ€ç®€å•æš´åŠ›çš„æƒ°æ€§æ±‚å€¼æ–¹æ³•å°±æ˜¯æ¯æ¬¡è¯»å– `computed` å°±é‡æ–°è®¡ç®—ä¸€æ¬¡ï¼Œä½†è¿™æ ·ååˆ†ä½æ•ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé«˜æ•ˆçš„ç¼“å­˜æœºåˆ¶ã€‚

æ¯æ¬¡è¯»å– `computed` å°±ä¼šæ‰§è¡Œå¦‚ä¸‹ä»£ç ä¸­çš„ `this._refresh()` æ–¹æ³•ï¼š

```ts {5}
Object.defineProperty(Computed.prototype, "value", {
	get(this: Computed) {
		// ..
		const node = addDependency(this);
		this._refresh();
		// ..
		return this._value;
	},
});
```

ç¼“å­˜é€»è¾‘ä¸»è¦é›†ä¸­åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ï¼Œç¼“å­˜æ‰‹æ®µå¯ä»¥æ€»ç»“ä¸ºå¦‚ä¸‹å››æ‹›ï¼š

1. å¦‚æœè‡ªä¸Šæ¬¡è¿è¡Œä»¥æ¥ï¼Œæ²¡æœ‰ä»»ä½•ä¿¡å·çš„å€¼å‘ç”Ÿæ”¹å˜ï¼Œç›´æ¥è¿”å›ç¼“å­˜ã€‚
    - è¿™æ˜¯é€šè¿‡æ¯”è¾ƒâ€œå…¨å±€ç‰ˆæœ¬å·â€æ¥å®ç°çš„ï¼Œå¦‚æœ `globalVersion` æ²¡å˜åŒ–ï¼Œè¯´æ˜æ²¡æœ‰ä»»ä½•ä¿¡å·æ”¹å˜ï¼Œä¸éœ€è¦é‡æ–°è®¡ç®—ï¼Œç›´æ¥è¿”å›å³å¯ï¼Œ
    
    ```ts {3}
    Computed.prototype._refresh = function () {
    	// ..
    	if (this._globalVersion === globalVersion) {
    		return true;
    	}
    	// ..
    }
    ```
    
2. å½“å‰ `computed` ä¾èµ–çš„ä¿¡å·æ²¡æœ‰å˜åŒ–ï¼Œåˆ™ç›´æ¥è¿”å›ç¼“å­˜ã€‚
    - ä»£ç ä½¿ç”¨ `flag` æ ‡å¿—ä½æ¥è¡¨ç¤ºå½“å‰çŠ¶æ€ï¼Œå¦‚æœå½“å‰ `computed` å¤„äºè·Ÿè¸ªä¸­ `TRACKING`ï¼Œä½†æ²¡æœ‰è¿‡æœŸ `OUTDATED`ï¼Œè¯´æ˜ `computed` è‡ªèº«ä¾èµ–çš„é‚£äº›ä¿¡å·éƒ½æ²¡æœ‰æ”¹å˜ï¼Œæ‰€ä»¥ä¸éœ€è¦é‡æ–°è®¡ç®—ï¼Œç›´æ¥è¿”å›å³å¯ã€‚
    
    ```ts {3}
    Computed.prototype._refresh = function () {
    	// ..
    	if ((this._flags & (OUTDATED | TRACKING)) === TRACKING) {
    		return true;
    	}
    	// ..
    }
    ```
    
3. æŒ‰ä¾èµ–é¡ºåºéå†æ£€æŸ¥ä»–ä»¬çš„ç‰ˆæœ¬å·ã€‚åªè¦æœ‰ä¸€ä¸ªä¾èµ–çš„ç‰ˆæœ¬å·æ”¹å˜å°±éœ€è¦é‡æ–°è®¡ç®— `computed`ã€‚å¦‚æœç‰ˆæœ¬å·éƒ½æ²¡å˜åŒ–ï¼Œå³ä½¿ä¾èµ–é¡ºåºæ”¹å˜ï¼Œä¹Ÿä¼šç›´æ¥é€€å‡ºå¹¶è¿”å›ç¼“å­˜çš„å€¼ã€‚
    
    ```ts {4}
    Computed.prototype._refresh = function () {
    	// ..
    	this._flags |= RUNNING;
    	if (this._version > 0 && !needsToRecompute(this)) {
    		this._flags &= ~RUNNING;
    		return true;
    	}
    	// ..
    }
    
    function needsToRecompute(target: Computed | Effect): boolean {
    	// _sources è¡¨ç¤ºå½“å‰ computed/effect ä¾èµ–çš„ä¿¡å· signal å¤´æŒ‡é’ˆ
    	// éå†å½“å‰ä¾èµ–çš„å…¨éƒ¨ä¿¡å·
    	for (
    		let node = target._sources;
    		node !== undefined;
    		node = node._nextSource
    	) {
    		if (
    			// 1. ç‰ˆæœ¬å·å˜åŒ–ï¼šæ¯”è¾ƒä¿¡å·çš„å½“å‰ç‰ˆæœ¬å· (node._source._version) 
    			//    ä¸ç›®æ ‡å¯¹è±¡è®°å½•çš„ç‰ˆæœ¬å· (node._version)ã€‚å¦‚æœä¸ç›¸ç­‰ï¼Œè¡¨ç¤ºä¿¡å·çš„å€¼å·²ç»å˜åŒ–ã€‚
    			node._source._version !== node._version ||
    			// 2. åˆ·æ–°å¤±è´¥ï¼šè°ƒç”¨ä¿¡å·çš„ _refresh() æ–¹æ³•ã€‚
    			//    å¦‚æœåˆ·æ–°å¤±è´¥ï¼ˆè¿”å› falseï¼‰ï¼Œå¯èƒ½æ˜¯å› ä¸ºä¾èµ–å¾ªç¯æˆ–å…¶ä»–é˜»ç¢åˆ·æ–°çš„é—®é¢˜ã€‚
    			!node._source._refresh() ||
    			// 3. åˆ·æ–°ä¹‹åå†æ¬¡æ£€æŸ¥ç‰ˆæœ¬å·ï¼šç¡®ä¿åœ¨åˆ·æ–°åæ²¡æœ‰æ–°çš„å˜åŒ–ã€‚
    			node._source._version !== node._version
    		) {
    			return true;
    		}
    	}
    	return false;
    }
    ```
    
4. å‰é¢çš„ç¼“å­˜æ¡ä»¶å¦‚æœéƒ½æ²¡å‘½ä¸­ï¼Œé‚£å°±å¾—é‡æ–°è®¡ç®—äº†ã€‚å½“ç„¶è¿˜ç•™äº†æœ€åä¸€æ‰‹ï¼Œåªæœ‰å½“é‡æ–°è®¡ç®—åçš„å€¼ä¸ä¹‹å‰ç¼“å­˜çš„å€¼ä¸åŒæ—¶ï¼Œæ‰ä¼šæ›´æ–°ç¼“å­˜è¿”å›æ–°å€¼ï¼Œå¹¶ä¸”å¢åŠ è®¡ç®—ä¿¡å·çš„ç‰ˆæœ¬å·ã€‚
    
    ```ts
    Computed.prototype._refresh = function () {
    	// ..
    	try {
    		// ..
    		const value = this._fn();
    		if (
    			this._flags & HAS_ERROR ||
    			this._value !== value ||
    			this._version === 0
    		) {
    			this._value = value;
    			this._flags &= ~HAS_ERROR;
    			this._version++;
    		}
    	} catch (err) {
    		this._value = err;
    		this._flags |= HAS_ERROR;
    		this._version++;
    	}
    	// ..
    }
    ```
    

### Computed æƒ°æ€§è®¢é˜…ä¹‹é“

1. **æƒ°æ€§è®¢é˜…**
    
    `computed` è®¢é˜…æ–¹æ³•å®ç°å¦‚ä¸‹ï¼š
    
    ```ts
    // ä½œä¸º computed signal è¢«è®¢é˜…æ—¶æ‰§è¡Œ
    Computed.prototype._subscribe = function (node) {
    	// this._targets ä¸º undefined è¯´æ˜ä¹‹å‰æ²¡æœ‰è¢«è®¢é˜…è¿‡ï¼Œæ‰€ä»¥æœ¬æ¬¡æ˜¯é¦–æ¬¡è¢«è®¢é˜…
    	if (this._targets === undefined) {
    		this._flags |= OUTDATED | TRACKING;
    
    		// é¦–æ¬¡è¢«è®¢é˜…æ—¶ï¼Œéå†å¹¶è®¢é˜…è‡ªèº«çš„æ‰€æœ‰ä¾èµ–é¡¹ï¼ˆthis._sourcesï¼‰
    		for (
    			let node = this._sources;
    			node !== undefined;
    			node = node._nextSource
    		) {
    			node._source._subscribe(node);
    		}
    	}
    	Signal.prototype._subscribe.call(this, node);
    };
    ```
    
    - æŒ‰éœ€è®¢é˜…ï¼š`computed`Â ä»…åœ¨è‡ªèº«ä½œä¸º `signal` ä¾èµ–é¡¹è¢«å…¶ä»–è®¢é˜…è€…**é¦–æ¬¡**è®¢é˜…æ—¶ï¼ˆå¦‚è¢«Â `effect`Â æˆ–æ¨¡æ¿å¼•ç”¨ï¼‰ï¼Œæ‰ä¼šè®¢é˜…å…¶è‡ªèº«çš„æ‰€æœ‰ä¾èµ–é¡¹ã€‚ç›¸å½“äºå»¶è¿Ÿæ‰§è¡Œï¼ŒæŒ‰éœ€è®¢é˜…ï¼Œå‡å°‘ä¸å¿…è¦çš„æ€§èƒ½å¼€é”€ã€‚
    - å†…å­˜èŠ‚çœï¼šæœªè¢«ä½¿ç”¨çš„Â `computed`ï¼ˆæ— è®¢é˜…è€…ï¼‰ä¸ä¼šå»ºç«‹ä¾èµ–å…³ç³»ï¼Œå‡å°‘ä¸å¿…è¦çš„å¼•ç”¨ã€‚
2. **è‡ªåŠ¨å–æ¶ˆè®¢é˜…**
    
    `computed` å–æ¶ˆè®¢é˜…æ–¹æ³•å®ç°å¦‚ä¸‹ï¼š
    
    ```ts
    Computed.prototype._unsubscribe = function (node) {
    	// ä»…å½“ computed signal ä»æœ‰è®¢é˜…è€…æ—¶æ‰§è¡Œå–æ¶ˆè®¢é˜…æ“ä½œ
    	if (this._targets !== undefined) {
    	
    		// è°ƒç”¨çˆ¶ç±» Signal çš„å–æ¶ˆè®¢é˜…é€»è¾‘ï¼ˆç§»é™¤å½“å‰è®¢é˜…è€…èŠ‚ç‚¹ï¼‰
    		Signal.prototype._unsubscribe.call(this, node);
    		
    		// å½“ computed ä¿¡å·å¤±å»æœ€åä¸€ä¸ªè®¢é˜…è€…ï¼ˆthis._targets å˜ä¸º undefinedï¼‰ï¼Œ
    		// éå†æ‰€æœ‰ä¾èµ–é¡¹ï¼ˆthis._sourcesï¼‰ï¼Œè§£é™¤å¯¹å®ƒä»¬çš„è®¢é˜…
    		if (this._targets === undefined) {
    			this._flags &= ~TRACKING;
    
    			for (
    				let node = this._sources;
    				node !== undefined;
    				node = node._nextSource
    			) {
    				node._source._unsubscribe(node);
    			}
    		}
    	}
    };
    ```
    
    - æŒ‰éœ€é‡Šæ”¾ï¼šå½“Â `computed signal`Â å¤±å»æ‰€æœ‰è®¢é˜…è€…æ—¶ï¼Œè‡ªåŠ¨å–æ¶ˆå¯¹å…¶ä¾èµ–é¡¹çš„è®¢é˜…ã€‚
    - å†…å­˜å›æ”¶ï¼šè§£é™¤å¼•ç”¨åï¼Œè‹¥è¿™äº›ä¾èµ–é¡¹ä¸å†è¢«å…¶ä»–ä»£ç ä½¿ç”¨ï¼Œå¯ä»¥è¢« JS å¼•æ“è‡ªåŠ¨ GCï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚

ä»ä¸Šé¢è®¢é˜…/å–æ¶ˆè®¢é˜…çš„ä¼˜åŒ–ç»†èŠ‚æ¥çœ‹ï¼Œæ•´ä½“éƒ½å®ç°äº†æŒ‰éœ€çš„æ€æƒ³ï¼ŒæŒ‰éœ€è®¢é˜…ï¼ŒæŒ‰éœ€é‡Šæ”¾ã€‚

## 2. Vue 3.5 å“åº”å¼é‡æ„

Vue 3.5 å“åº”å¼é‡æ„å—å¯å‘äº Preact Signalsï¼ˆ[PR](https://github.com/vuejs/core/pull/10397)ï¼‰ï¼š

- æ”¹ä¸ºåŒå‘é“¾è¡¨ç»“æ„ï¼Œæ–°å¢ä¸­é—´èŠ‚ç‚¹ linkï¼Œç±»ä¼¼ Preact Signals ä¸­çš„ Node èŠ‚ç‚¹ã€‚
- å¢åŠ ç‰ˆæœ¬è®¡æ•°
- `computed` æƒ°æ€§è®¢é˜…/è‡ªåŠ¨å–æ¶ˆè®¢é˜…

å¯ä»¥è¯´è¿™ä¸‰ä¸ªä¸»è¦ä¼˜åŒ–éƒ½å¸å–äº† Preact Signals çš„ç²¾åï¼Œæ­£å¦‚å‰æ–‡æ‰€è¯´ï¼Œåœ¨ Vue3.5 ä¹‹å‰ï¼Œ`Sub`ï¼ˆè®¢é˜…è€…ï¼‰ å’Œ `Dep`ï¼ˆä¾èµ–é¡¹ï¼‰ å…³ç³»æ˜¯å¤šå¯¹å¤šï¼Œå¹¶ä¸”ä¸¤è€…æ˜¯ç›´æ¥å…³è”çš„ã€‚è€Œé‡æ„ä¹‹åä¾èµ–å’Œè®¢é˜…è€…ä¹‹é—´ä¸å†ç›´æ¥å…³è”ï¼Œè€Œæ˜¯é€šè¿‡ä¸­é—´èŠ‚ç‚¹æ¥å…³è”ã€‚é‡æ„åæºç å…¶å®å’Œå‰æ–‡åˆ†æçš„ Preact Signals æºç å¤§æŸ¥ä¸æŸ¥ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€åˆ—ä¸¾ï¼Œæ„Ÿå…´è¶£åœ°åŒå­¦å¯ä»¥è‡ªè¡Œæ¢ç´¢ã€‚

## 3. Vue çš„æœªæ¥ï¼šAlien Signals

Vue 3.5 å·¦æ‰‹åŒå‘é“¾è¡¨ï¼Œå³æ‰‹ç‰ˆæœ¬è®¡æ•°ï¼Œçœ‹ä¼¼é‡‘èº«å·²é“¸ï¼Œç¥åŠŸå·²æˆã€‚ä½†å®ƒå¹¶æœªåœæ­¢å‰è¿›ï¼Œä»ç›®å‰çš„ [PR](https://github.com/vuejs/core/pull/12349) æ¥çœ‹ï¼Œåœ¨æœªæ¥çš„ç‰ˆæœ¬å°†å¼•å…¥ [alien-signals](https://github.com/stackblitz/alien-signals) æ¥è¿›ä¸€æ­¥ä¼˜åŒ–å“åº”å¼ç³»ç»Ÿï¼Œéš¾é“è¯´è¿˜æœ‰é«˜æ‰‹ï¼Ÿ

æ¬²çŸ¥åäº‹ï¼Œä¸”å¬ä¸‹å›åˆ†è§£ï½ğŸµ

## å‚è€ƒ

- *Preact Signals åšå®¢-ä»‹ç»ï¼š[https://preactjs.com/blog/introducing-signals](https://preactjs.com/blog/introducing-signals)*
- *Preact Signals åšå®¢-æ€§èƒ½æå‡ï¼š[https://preactjs.com/blog/signal-boosting](https://preactjs.com/blog/signal-boosting)*
- *React ä¸­å¼•å…¥ Signals çš„ç•…æƒ³æ¢ç´¢ï¼š[https://www.builder.io/blog/usesignal-is-the-future-of-web-frameworks](https://www.builder.io/blog/usesignal-is-the-future-of-web-frameworks)*
- *Vue3.5å“åº”å¼é‡æ„ä¸­çš„åŒå‘é“¾è¡¨åˆ†æï¼š[https://mp.weixin.qq.com/s/_KQyb9cQv-r-tR2gTT0ZCQ](https://mp.weixin.qq.com/s/_KQyb9cQv-r-tR2gTT0ZCQ)*
- *Vue3.5å“åº”å¼é‡æ„ä¸­çš„ç‰ˆæœ¬è®¡æ•°åˆ†æï¼š[https://mp.weixin.qq.com/s/5wK7FT0RRnLvj92iu2hQWQ](https://mp.weixin.qq.com/s/5wK7FT0RRnLvj92iu2hQWQ)*